name: Deploy Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_setup:
        description: 'Force re-run server setup'
        required: false
        default: false
        type: boolean

env:
  DOMAIN: ${{ secrets.DOMAIN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.DOMAIN }} >> ~/.ssh/known_hosts

      - name: Check if server needs setup
        id: check_setup
        run: |
          # Check if root domain cert exists (indicates setup was done)
          SETUP_DONE=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            root@${{ env.DOMAIN }} \
            "test -f /usr/local/bin/ensure-cert.sh && test -d /etc/letsencrypt/live/${{ env.DOMAIN }} && echo 'yes' || echo 'no'")
          
          echo "setup_done=$SETUP_DONE" >> $GITHUB_OUTPUT
          
          if [ "$SETUP_DONE" = "yes" ]; then
            echo "✓ Server is already set up"
          else
            echo "→ Server needs setup"
          fi

      - name: Run server setup
        if: steps.check_setup.outputs.setup_done == 'no' || inputs.force_setup == true
        run: |
          echo "Setting up server for domain: ${{ env.DOMAIN }}"
          
          # Copy setup files to server
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            server-setup/setup.sh \
            server-setup/nginx-apps.conf \
            root@${{ env.DOMAIN }}:/tmp/
          
          # Run setup script (now only needs domain and email, no Cloudflare token)
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            root@${{ env.DOMAIN }} \
            "chmod +x /tmp/setup.sh && /tmp/setup.sh ${{ env.DOMAIN }} ${{ secrets.LETSENCRYPT_EMAIL }}"

      - name: Generate app index
        run: |
          # Skip if user has a custom _root/index.html
          if [ -f "_root/index.html" ]; then
            echo "Custom _root/index.html found, skipping generation"
            exit 0
          fi
          
          # Find all app directories (exclude system folders)
          APPS=$(find . -maxdepth 1 -type d \
            ! -name '.' \
            ! -name '.git' \
            ! -name '.github' \
            ! -name 'server-setup' \
            ! -name '_root' \
            -printf '%f\n' | sort)
          
          # Generate _root/index.html
          mkdir -p _root
          cat > _root/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Apps</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
                      min-height: 100vh;
                      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
                      color: #e8e8e8;
                      padding: 3rem 1.5rem;
                  }
                  .container {
                      max-width: 600px;
                      margin: 0 auto;
                  }
                  h1 {
                      font-size: 2.5rem;
                      font-weight: 600;
                      margin-bottom: 2rem;
                      background: linear-gradient(135deg, #00d9ff, #00ff88);
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      background-clip: text;
                  }
                  .apps {
                      display: flex;
                      flex-direction: column;
                      gap: 0.75rem;
                  }
                  a {
                      display: block;
                      padding: 1rem 1.25rem;
                      background: rgba(255, 255, 255, 0.03);
                      border: 1px solid rgba(255, 255, 255, 0.08);
                      border-radius: 12px;
                      color: #fff;
                      text-decoration: none;
                      font-size: 1.1rem;
                      transition: all 0.2s ease;
                  }
                  a:hover {
                      background: rgba(255, 255, 255, 0.08);
                      border-color: rgba(0, 217, 255, 0.3);
                      transform: translateX(4px);
                  }
                  .empty {
                      color: rgba(255, 255, 255, 0.5);
                      font-style: italic;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Apps</h1>
                  <div class="apps">
          HTMLEOF
          
          # Add links for each app
          DOMAIN="${{ env.DOMAIN }}"
          APP_COUNT=0
          for app in $APPS; do
              echo "            <a href=\"https://${app}.${DOMAIN}\">${app}</a>" >> _root/index.html
              APP_COUNT=$((APP_COUNT + 1))
          done
          
          # Handle empty state
          if [ $APP_COUNT -eq 0 ]; then
              echo '            <p class="empty">No apps deployed yet.</p>' >> _root/index.html
          fi
          
          # Close HTML
          cat >> _root/index.html << 'HTMLEOF'
                  </div>
              </div>
          </body>
          </html>
          HTMLEOF
          
          echo "Generated index with $APP_COUNT apps"

      - name: Deploy apps via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'server-setup' \
            --exclude 'README.md' \
            --exclude 'LICENSE' \
            --exclude '.gitignore' \
            --exclude '*.md' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ root@${{ env.DOMAIN }}:/var/www/apps/

      - name: Issue SSL certificates for apps
        run: |
          DOMAIN="${{ env.DOMAIN }}"
          EMAIL="${{ secrets.LETSENCRYPT_EMAIL }}"
          
          # Find all app directories
          APPS=$(find . -maxdepth 1 -type d \
            ! -name '.' \
            ! -name '.git' \
            ! -name '.github' \
            ! -name 'server-setup' \
            ! -name '_root' \
            -printf '%f\n' | sort)
          
          CERTS_ISSUED=0
          for app in $APPS; do
            echo "Ensuring certificate for ${app}.${DOMAIN}..."
            
            # Run ensure-cert.sh on the server
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
              root@${{ env.DOMAIN }} \
              "/usr/local/bin/ensure-cert.sh $app $DOMAIN $EMAIL" && CERTS_ISSUED=$((CERTS_ISSUED + 1)) || true
          done
          
          echo "Processed certificates for $CERTS_ISSUED apps"

      - name: Update nginx config and reload
        run: |
          # Copy latest nginx config
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            server-setup/nginx-apps.conf \
            root@${{ env.DOMAIN }}:/tmp/nginx-apps.conf
          
          # Update config and reload nginx
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            root@${{ env.DOMAIN }} \
            "sed 's/DOMAIN_PLACEHOLDER/${{ env.DOMAIN }}/g' /tmp/nginx-apps.conf > /etc/nginx/sites-available/apps && \
             ln -sf /etc/nginx/sites-available/apps /etc/nginx/sites-enabled/apps && \
             nginx -t && systemctl reload nginx"

      - name: Clean up
        run: rm -f ~/.ssh/deploy_key
